<!-- Feedback Widget -->
<div x-data="feedbackWidget('{{ doc.name }}')" class="flex flex-col items-start sm:items-end">
    <div class="flex flex-col items-start sm:items-center gap-2">
        <span class="text-sm text-[var(--ink-gray-5)]">Was this helpful?</span>

        <!-- Reaction Buttons (pill-shaped toggle group) -->
        {% set reactions = [
            {"type": "Good", "mouth": '<path d="M8 14s1.5 2 4 2 4-2 4-2"/>'},
            {"type": "Ok", "mouth": '<line x1="8" y1="15" x2="16" y2="15"/>'},
            {"type": "Bad", "mouth": '<path d="M16 16s-1.5-2-4-2-4 2-4 2"/>'}
        ] %}
        <fieldset class="inline-flex rounded-full bg-[var(--surface-gray-2)] p-0.5" role="radiogroup" aria-label="Feedback rating">
            {% for reaction in reactions %}
            <button type="button"
                    @click="selectFeedback('{{ reaction.type }}')"
                    :disabled="submitted"
                    :class="feedbackType === '{{ reaction.type }}' ? 'bg-[var(--surface-white)] shadow-sm' : 'hover:bg-[var(--surface-gray-4)]'"
                    class="p-1.5 rounded-full transition-all duration-200 cursor-pointer disabled:cursor-not-allowed disabled:opacity-60"
                    role="radio"
                    :aria-checked="feedbackType === '{{ reaction.type }}'"
                    aria-label="{{ reaction.type }}">
                <svg class="w-4 h-4" :class="feedbackType === '{{ reaction.type }}' ? 'text-[var(--ink-gray-9)]' : 'text-[var(--ink-gray-5)]'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    {{ reaction.mouth | safe }}
                    <line x1="9" y1="9" x2="9.01" y2="9"/>
                    <line x1="15" y1="9" x2="15.01" y2="9"/>
                </svg>
            </button>
            {% endfor %}
        </fieldset>
    </div>

    <!-- Optional text + Submit (shown after type selected) -->
    <div x-show="feedbackType" x-cloak
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 -translate-y-1"
         x-transition:enter-end="opacity-100 translate-y-0"
         class="mt-2 w-72">
        <form @submit.prevent="submit()" class="relative">
            <textarea x-ref="feedbackInput"
                      x-model="comment"
                      name="feedback"
                      :disabled="submitted"
                      placeholder="Anything you'd like to add?"
                      rows="3"
                      class="w-full px-4 py-3 pr-20 text-sm rounded-xl border border-[var(--outline-gray-2)] bg-[var(--surface-white)] text-[var(--ink-gray-9)] placeholder-[var(--ink-gray-4)] focus:outline-none focus:ring-2 focus:ring-[var(--outline-gray-3)] resize-none disabled:opacity-60"></textarea>

            <!-- Submit button OR Thank you message -->
            <div class="absolute bottom-3 right-3">
                <button x-show="!submitted"
                        type="submit"
                        :disabled="submitting"
                        class="px-2.5 py-1 text-xs font-medium rounded-sm bg-[var(--surface-gray-3)] text-[var(--ink-gray-7)] hover:bg-[var(--surface-gray-4)] hover:text-[var(--ink-gray-9)] transition-colors duration-200 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed">
                    <span x-show="!submitting">Submit</span>
                    <span x-show="submitting" class="flex items-center gap-1">
                        <svg class="animate-spin h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </span>
                </button>
                <span x-show="submitted" class="flex items-center gap-1 text-xs font-medium text-green-600">
                    <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M9 12l2 2 4-4"/>
                    </svg>
                    Thanks!
                </span>
            </div>
        </form>
    </div>
</div>

<script>
    // Initialize feedback store for external reset capability
    document.addEventListener('alpine:init', () => {
        Alpine.store('feedback', {
            refreshCallback: null,

            setRefreshCallback(callback) {
                this.refreshCallback = callback;
            },

            refresh() {
                if (this.refreshCallback) {
                    this.refreshCallback();
                }
            }
        });
    });

    function feedbackWidget(docName) {
        return {
            docName: docName,
            feedbackType: null,
            comment: '',
            submitting: false,
            submitted: false,

            init() {
                // Register refresh callback with store
                Alpine.store('feedback').setRefreshCallback(() => {
                    this.reset();
                });
            },

            reset() {
                this.feedbackType = null;
                this.comment = '';
                this.submitting = false;
                this.submitted = false;
            },

            selectFeedback(type) {
                this.feedbackType = type;
                // Focus the textarea after it renders
                this.$nextTick(() => {
                    if (this.$refs.feedbackInput) {
                        this.$refs.feedbackInput.focus();
                    }
                });
            },

            async submit() {
                if (!this.feedbackType || this.submitting || this.submitted) return;

                this.submitting = true;

                try {
                    const response = await fetch('/api/method/wiki.wiki.doctype.wiki_feedback.wiki_feedback.submit_feedback', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'X-Frappe-CSRF-Token': window.CSRF_TOKEN
                        },
                        body: JSON.stringify({
                            wiki_document: this.docName,
                            type: this.feedbackType,
                            feedback: this.comment || null
                        })
                    });

                    const data = await response.json();

                    if (response.ok && !data.exc_type) {
                        this.submitted = true;
                    } else if (data.exc_type === 'RateLimitExceededError') {
                        alert('You have submitted too many feedbacks. Please try again later.');
                    } else {
                        console.error('Feedback submission failed:', data);
                    }
                } catch (error) {
                    console.error('Error submitting feedback:', error);
                } finally {
                    this.submitting = false;
                }
            }
        }
    }
</script>
