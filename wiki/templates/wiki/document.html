{% extends "templates/wiki/layout.html" %}
{% from "templates/wiki/macros/buttons.html" import ghost_button, render_icon, dropdown, dropdown_item, dropdown_end %}

{% block title %}
    {{ doc.title }}
{% endblock %}

{% block body %}
<div x-data="{ ...wikiDocument(), ...tocScrollSpy() }">
    <!-- Main Content -->
    <article class="max-w-4xl mx-auto xl:mr-72">
        <!-- Page Header -->
        <header class="mb-8 pb-4 border-b border-[var(--outline-gray-1)]">
            <h1 class="text-3xl font-bold text-[var(--ink-gray-9)] mb-4">{{ doc.title }}</h1>

            <!-- Action Buttons -->
            <div class="flex items-center gap-3">
                <!-- Copy Markdown Button -->
                <button @click="copyMarkdown()"
                        class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-[var(--ink-gray-5)] hover:text-[var(--ink-gray-9)] hover:bg-[var(--surface-gray-2)] rounded-md transition-colors duration-200 cursor-pointer">
                    <template x-if="!copied">
                        {{ render_icon("clipboard") }}
                    </template>
                    <template x-if="copied">
                        {{ render_icon("check", "text-[var(--ink-green-2)]") }}
                    </template>
                    <span x-text="copied ? 'Copied!' : 'Copy Markdown'"></span>
                </button>

                <!-- Ask AI Dropdown -->
                {% set ai_providers = [
                    {"key": "claude", "text": "Ask Claude", "icon": "claude"},
                    {"key": "openai", "text": "Ask OpenAI", "icon": "openai"},
                    {"key": "t3", "text": "Ask T3 Chat", "icon": "t3"},
                    {"key": "perplexity", "text": "Ask Perplexity", "icon": "perplexity"}
                ] %}
                {{ dropdown(text="Ask AI", icon="sparkles") }}
                    {% for provider in ai_providers %}
                        {{ dropdown_item(text=provider.text, icon=provider.icon, href_expr="getAIUrl('" ~ provider.key ~ "')") }}
                    {% endfor %}
                {{ dropdown_end() }}

                <!-- Edit Page Link -->
                {{ ghost_button(text="Edit Page", icon="edit", href=doc.get_edit_link()) }}
            </div>
        </header>

        <!-- Page Content -->
        <div class="prose prose-lg max-w-none" id="wiki-content">
            {{ rendered_content }}
        </div>
    </article>

    {% include "templates/wiki/includes/toc.html" %}
</div>

<script>
    function wikiDocument() {
        return {
            copied: false,
            markdown: {{ raw_markdown | tojson }},

            copyMarkdown() {
                navigator.clipboard.writeText(this.markdown).then(() => {
                    this.copied = true;
                    setTimeout(() => {
                        this.copied = false;
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy markdown:', err);
                });
            },

            getAIUrl(provider) {
                const encodedContent = encodeURIComponent(this.markdown);
                const urls = {
                    'claude': `https://claude.ai/new?q=${encodedContent}`,
                    'openai': `https://chatgpt.com/?q=${encodedContent}`,
                    't3': `https://t3.chat/new?q=${encodedContent}`,
                    'perplexity': `https://www.perplexity.ai/search?q=${encodedContent}`
                };
                return urls[provider] || '#';
            }
        }
    }
</script>
{% endblock %}